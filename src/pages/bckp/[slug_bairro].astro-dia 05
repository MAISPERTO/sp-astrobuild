---
import client from '../lib/directus';
import { readItems } from '@directus/sdk';

// 1) Diz ao Astro quais bairros existem (gera as rotas estaticamente)
export async function getStaticPaths() {
  const bairros = await client.request(
    readItems('mp_bairros', {
      fields: ['slug_bairro', 'nome_bairro'],
      limit: -1, // -1 = sem limite (pega todos)
      sort: ['nome_bairro'],
    })
  );

  return bairros.map((b) => ({
    params: { slug_bairro: b.slug_bairro },
    props: { bairroNome: b.nome_bairro },
  }));
}

// 2) Pega o slug da URL e carrega os dados do bairro
const { slug_bairro } = Astro.params;

const [bairros] = await Promise.all([
  client.request(
    readItems('mp_bairros', {
      filter: { slug_bairro: { _eq: slug_bairro } },
      limit: 1,
    })
  ),
]);

const bairro = bairros[0] ?? null;
---

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>
      {bairro
        ? `${bairro.nome_bairro} • Negócios Locais MAISPERTO`
        : 'Bairro não encontrado • Negócios Locais MAISPERTO'}
    </title>
  </head>
  <body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 2rem; background: #f5f5f7;">
    <main style="max-width: 960px; margin: 0 auto;">
      {!bairro ? (
        <>
          <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">
            <a href="/" style="color: #3366ee; text-decoration: none;">← Voltar para São Paulo</a>
          </p>
          <h1>Bairro não encontrado</h1>
          <p>Verifique o endereço ou volte para a página inicial.</p>
        </>
      ) : (
        <>
          <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">
            <a href="/" style="color: #3366ee; text-decoration: none;">← São Paulo</a>
          </p>

          <h1 style="margin-top: 0; font-size: 2rem;">
            {bairro.nome_bairro}
          </h1>

          <p style="color: #555; margin-bottom: 1.5rem;">
            Em breve: vitrines de negócios locais, classificados e ofertas segmentadas para o bairro {bairro.nome_bairro}.
          </p>

          <section style="padding: 1rem 1.25rem; border-radius: 0.75rem; background: white; border: 1px solid #ddd;">
            <h2 style="font-size: 1.2rem; margin-top: 0;">Resumo técnico (debug)</h2>
            <pre style="font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word;">
slug_bairro: {bairro.slug_bairro}
id: {bairro.id}
            </pre>
          </section>
        </>
      )}
    </main>
  </body>
</html>
