---
import client from "../lib/directus";
import { readItems } from "@directus/sdk";

// Buscar todas as categorias locais ativas com campos necessários
const categorias = await client.request(
  readItems("mp_categorias_locais", {
    filter: {
      ativo: { _eq: true },
    },
    fields: [
      "id",
      "nome_nicho",
      "slug_nicho",
      "descricao_curta_nicho",
      "nivel_nicho",
      "full_slug_nicho",
      "ordem_exibicao",
      "parent_nicho", // pode vir como ID ou objeto, tratamos abaixo
    ],
    sort: ["nivel_nicho", "ordem_exibicao", "nome_nicho"],
    limit: 500,
  })
);

// Função utilitária para ordenar por ordem_exibicao + nome_nicho
function sortCats(list) {
  return [...list].sort((a, b) => {
    const oa = a.ordem_exibicao ?? 0;
    const ob = b.ordem_exibicao ?? 0;
    if (oa !== ob) return oa - ob;
    return (a.nome_nicho || "").localeCompare(b.nome_nicho || "");
  });
}

// 1) Nível 1 (raiz)
const nivel1 = sortCats(categorias.filter((c) => c.nivel_nicho === 1));
// Se quiser só as 7 principais:
const nivel1Top = nivel1.slice(0, 7);

// 2) Agrupar filhos por parent_nicho (tratando ID ou objeto)
const porPai = new Map();
for (const cat of categorias) {
  let parentId = null;

  if (cat.parent_nicho) {
    if (typeof cat.parent_nicho === "object") {
      parentId = cat.parent_nicho.id ?? null;
    } else {
      parentId = cat.parent_nicho; // se vier como ID direto
    }
  }

  if (!porPai.has(parentId)) {
    porPai.set(parentId, []);
  }
  porPai.get(parentId).push(cat);
}
---

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Categorias de Negócios Locais • MAISPERTO São Paulo</title>
  </head>
  <body
    style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 2rem; background: #f5f5f7;"
  >
    <header style="max-width: 960px; margin: 0 auto 1.5rem auto;">
      <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem;">
        Categorias de Negócios Locais
      </h1>
      <p style="margin: 0; color: #555;">
        Mapa visual dos nichos locais (Nível 1, 2 e 3) para facilitar a escolha de
        categorias por anunciantes e afiliados.
      </p>
    </header>

    <main style="max-width: 960px; margin: 0 auto;">
      {nivel1Top.length === 0 ? (
        <p style="color: #777;">
          Nenhuma categoria de nível 1 encontrada em <code>mp_categorias_locais</code>.
        </p>
      ) : (
        <>
          {/* Índice rápido de N1 (atalho) */}
          <nav
            style="margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: #ffffff; border-radius: 0.75rem; border: 1px solid #ddd;"
          >
            <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">
              Acesse rapidamente um grupo de categorias:
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              {nivel1Top.map((n1) => (
                <a
                  href={`#n1-${n1.slug_nicho || n1.id}`}
                  style="padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid #ccc; background: #f9fafb; font-size: 0.9rem; text-decoration: none; color: #333;"
                >
                  {n1.nome_nicho}
                </a>
              ))}
            </div>
          </nav>

          {/* Blocos N1 com N2 e N3 */}
          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            {nivel1Top.map((n1) => {
              // Filhas N2 desse N1
              const filhasN2 = sortCats(
                (porPai.get(n1.id) || []).filter((c) => c.nivel_nicho === 2)
              );

              return (
                <section
                  id={`n1-${n1.slug_nicho || n1.id}`}
                  style="background: white; border: 1px solid #ddd; border-radius: 0.75rem; padding: 1rem 1.25rem;"
                >
                  <h2 style="margin: 0 0 0.5rem 0; font-size: 1.3rem;">
                    [N1] {n1.nome_nicho}
                  </h2>

                  {n1.descricao_curta_nicho && (
                    <p
                      style="margin: 0 0 0.75rem 0; color: #555; font-size: 0.95rem;"
                    >
                      {n1.descricao_curta_nicho}
                    </p>
                  )}

                  {filhasN2.length === 0 ? (
                    <p
                      style="margin: 0.5rem 0 0 0; color: #777; font-size: 0.9rem;"
                    >
                      Ainda não há subcategorias cadastradas para este grupo.
                    </p>
                  ) : (
                    <ul style="list-style: none; padding-left: 0; margin: 0;">
                      {filhasN2.map((n2) => {
                        // Filhas N3 desse N2
                        const filhasN3 = sortCats(
                          (porPai.get(n2.id) || []).filter(
                            (c) => c.nivel_nicho === 3
                          )
                        );

                        return (
                          <li style="margin-top: 0.5rem;">
                            <div
                              style="font-weight: 600; font-size: 0.98rem;"
                            >
                              [N2] {n2.nome_nicho}
                            </div>

                            {n2.descricao_curta_nicho && (
                              <div
                                style="font-size: 0.9rem; color: #555; margin-bottom: 0.25rem;"
                              >
                                {n2.descricao_curta_nicho}
                              </div>
                            )}

                            {filhasN3.length > 0 && (
                              <ul
                                style="list-style: none; padding-left: 1.25rem; margin: 0.25rem 0 0 0;"
                              >
                                {filhasN3.map((n3) => (
                                  <li style="margin: 0.15rem 0;">
                                    <a
                                      href={`/${n3.full_slug_nicho}`}
                                      style="text-decoration: none; color: #1d4ed8; font-size: 0.9rem;"
                                    >
                                      [N3] {n3.nome_nicho}
                                    </a>
                                    {n3.descricao_curta_nicho && (
                                      <span
                                        style="color: #666; font-size: 0.85rem;"
                                      >
                                        {" "}
                                        – {n3.descricao_curta_nicho}
                                      </span>
                                    )}
                                  </li>
                                ))}
                              </ul>
                            )}
                          </li>
                        );
                      })}
                    </ul>
                  )}
                </section>
              );
            })}
          </div>
        </>
      )}
    </main>

    <footer
      style="max-width: 960px; margin: 2rem auto 0 auto; font-size: 0.8rem; color: #777;"
    >
      <p style="margin: 0;">
        Mapa gerado a partir de <code>mp_categorias_locais</code> (níveis 1, 2 e 3).
      </p>
    </footer>
  </body>
</html>
