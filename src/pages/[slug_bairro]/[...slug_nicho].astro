---
import client from "../../lib/directus";
import { readItems } from "@directus/sdk";
import CardLocalPrincipal from "../../components/CardLocalPrincipal.astro";
import CardPatrocinador from "../../components/CardPatrocinador.astro";

/**
 * Por enquanto não vamos pré-gerar nenhuma rota de categoria+bairro.
 * Isso evita o erro GetStaticPathsRequired, e qualquer URL desse tipo
 * vai cair em 404 até ligarmos de verdade.
 */
export async function getStaticPaths() {
  return [];
}

const { slug_bairro, slug_nicho } = Astro.params;

// slug_nicho pode ser string ou array
const partesNicho = Array.isArray(slug_nicho) ? slug_nicho : [slug_nicho];
const fullSlugNicho = partesNicho.join("/");

let bairro = null;
let nicho = null;
let cards = [];
let erroCarregamento = null;

try {
  const bairros = await client.request(
    readItems("mp_bairros", {
      filter: {
        slug_bairro: { _eq: slug_bairro },
        ativo: { _eq: true },
      },
      limit: 1,
    })
  );
  bairro = bairros?.[0] ?? null;

  if (!bairro) {
    erroCarregamento = `Bairro não encontrado para slug_bairro = ${slug_bairro}`;
  } else {
    const nichos = await client.request(
      readItems("mp_categorias_locais", {
        filter: {
          full_slug_nicho: { _eq: fullSlugNicho },
          ativo: { _eq: true },
        },
        limit: 1,
      })
    );
    nicho = nichos?.[0] ?? null;

    if (!nicho) {
      erroCarregamento = `Nicho local não encontrado para full_slug_nicho = ${fullSlugNicho}`;
    } else {
      cards = await client.request(
        readItems("mp_cards_anunciantes", {
          filter: {
            ativo: { _eq: true },
          },
          sort: ["ordem_exibicao"],
          limit: 20,
        })
      );
    }
  }
} catch (e) {
  console.error("Erro ao carregar dados do bairro + nicho:", e);
  erroCarregamento = "Erro ao carregar dados. Verifique o console do servidor.";
}

const card1 = cards?.[0];
const outrosCards = cards?.slice(1) ?? [];

const baseUrl = import.meta.env.DIRECTUS_URL || "";
const pageTitle =
  bairro && nicho
    ? `${nicho.nome_nicho ?? "Categoria"} em ${bairro.nome_bairro} - São Paulo`
    : "Categoria local - MaisPerto";
---

<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>{pageTitle}</title>
  </head>
  <body class="bg-gray-100">
    <main class="py-8">
      <div class="mx-auto max-w-4xl px-4">
        {erroCarregamento ? (
          <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-xl p-4">
            <p class="font-semibold mb-1">Rota de categoria+bairro ainda não ligada.</p>
            <p class="text-sm">{erroCarregamento}</p>
          </div>
        ) : bairro && nicho ? (
          <header class="mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
              {nicho.nome_nicho ?? "Categoria"} em {bairro.nome_bairro}
            </h1>
            <p class="text-gray-700 mt-2">
              (Tela de teste — rota de categoria+bairro será ligada depois.)
            </p>
          </header>
        ) : (
          <p class="text-gray-700">Carregando informações da categoria local…</p>
        )}
      </div>

      {/* Por enquanto, o conteúdo aqui é secundário. Vamos focar em fazer /bela-vista funcionar primeiro. */}
    </main>
  </body>
</html>
