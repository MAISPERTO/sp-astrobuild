---
import client from '../lib/directus';
import { readItems } from '@directus/sdk';

/**
 * IMPORTANTE:
 * Este arquivo é específico do subdomínio da cidade (sp.maisperto.com.br).
 * Portanto, aqui filtramos os bairros apenas pela cidade_relacionada.
 *
 * Defina abaixo o ID da cidade São Paulo na tabela mp_cidades
 * (pegue esse ID direto no Directus).
 */
const CIDADE_SP_ID = '1';

// Bairros da cidade (mp_bairros)
const bairros = await client.request(
  readItems('mp_bairros', {
    filter: {
      ativo: { _eq: true },
      cidade_relacionada: { _eq: CIDADE_SP_ID },
    },
    sort: ['ordem_prioridade', 'nome_bairro'],
    limit: 200,
  })
);

// Categorias locais (mp_categorias_locais)
const categoriasLocais = await client.request(
  readItems('mp_categorias_locais', {
    filter: {
      ativo: { _eq: true },
    },
    sort: ['ordem_exibicao', 'nome_nicho'],
    limit: 50,
  })
);
---

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>São Paulo • Negócios Locais MAISPERTO</title>
    <meta
      name="description"
      content="Encontre negócios locais, serviços e profissionais em São Paulo. Navegue pelos nichos da cidade e depois filtre por bairros e regiões."
    />
  </head>
  <body style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 2rem; background: #f5f5f7;">
    <header style="max-width: 960px; margin: 0 auto 2rem auto;">
      <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem;">
        São Paulo • Negócios Locais MAISPERTO
      </h1>
      <p style="margin: 0; color: #555;">
        Versão inicial de testes conectada ao Directus. Primeiro escolha o <strong>nicho</strong> da cidade, depois aplique o filtro por <strong>bairro</strong> ou <strong>região</strong> na URL.
      </p>
    </header>

    <main style="max-width: 960px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1.5fr; gap: 2rem;">
      <!-- Coluna bairros -->
      <section>
        <h2 style="font-size: 1.4rem; margin-bottom: 0.75rem;">Bairros cadastrados em São Paulo</h2>

        {bairros.length === 0 ? (
          <p style="color: #777;">Nenhum bairro ativo cadastrado para esta cidade em <code>mp_bairros</code>.</p>
        ) : (
          <>
            <p style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #666;">
              Estes são os bairros e regiões cadastrados. Nas próximas etapas, cada nicho poderá ser combinado com um bairro na URL, por exemplo:
              <br />
              <code>/servicos-casa-e-construcao/moema</code>
            </p>

            <ul style="list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.5rem;">
              {bairros.map((b) => (
                <li>
                  <span
                    style="display: block; padding: 0.5rem 0.75rem; border-radius: 999px; background: white; border: 1px solid #ddd; color: #333; font-size: 0.95rem;"
                  >
                    {b.nome_bairro}
                  </span>
                </li>
              ))}
            </ul>
          </>
        )}
      </section>

      <!-- Coluna categorias/nichos -->
      <section>
        <h2 style="font-size: 1.4rem; margin-bottom: 0.75rem;">Categorias locais (navegue por nichos)</h2>

        {categoriasLocais.length === 0 ? (
          <p style="color: #777;">Nenhuma categoria ativa cadastrada em <code>mp_categorias_locais</code>.</p>
        ) : (
          <>
            <p style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #666;">
              Clique em um nicho para ver a cidade inteira. Depois, você poderá usar URLs como:
              <br />
              <code>/[full_slug_nicho]/[bairro-ou-regiao]</code>
            </p>

            <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.5rem;">
              {categoriasLocais.map((c) => (
                <li>
                  <a
                    href={`/${c.full_slug_nicho}`}
                    style="text-decoration: none; color: inherit;"
                  >
                    <div
                      style="padding: 0.6rem 0.75rem; border-radius: 0.75rem; background: white; border: 1px solid #ddd;"
                    >
                      <div style="font-weight: 600; margin-bottom: 0.15rem;">
                        {c.nome_nicho}
                      </div>
                      {c.descricao_curta_nicho && (
                        <div style="font-size: 0.9rem; color: #555;">
                          {c.descricao_curta_nicho}
                        </div>
                      )}
                      {c.full_slug_nicho && (
                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                          URL base do nicho: <code>/{c.full_slug_nicho}</code>
                        </div>
                      )}
                    </div>
                  </a>
                </li>
              ))}
            </ul>
          </>
        )}
      </section>
    </main>

    <footer style="max-width: 960px; margin: 2rem auto 0 auto; font-size: 0.8rem; color: #777;">
      <p style="margin: 0;">
        MVP • Dados carregados via Directus (<code>mp_bairros</code> e <code>mp_categorias_locais</code>). Combinações <code>nicho + bairro</code> serão resolvidas pela rota dinâmica.
      </p>
    </footer>
  </body>
</html>
