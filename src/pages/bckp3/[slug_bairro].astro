---
import client from "../lib/directus";
import { readItems } from "@directus/sdk";
import CardLocalPrincipal from "../components/CardLocalPrincipal.astro";
import CardPatrocinador from "../components/CardPatrocinador.astro";

/**
 * Gera rotas estáticas para bairros ativos da cidade 1 (São Paulo).
 */
export async function getStaticPaths() {
  const bairros = await client.request(
    readItems("mp_bairros", {
      filter: {
        ativo: { _eq: true },
        cidade_relacionada: { _eq: 1 }, // São Paulo
      },
      fields: ["slug_bairro"],
      limit: 500,
    })
  );

  return bairros.map((b) => ({
    params: {
      slug_bairro: b.slug_bairro,
    },
  }));
}

const { slug_bairro } = Astro.params;

let bairro = null;
let cards = [];
let erroBairro = null;
let avisoCards = null;
let categoriasN1 = [];

// 1) Buscar bairro (erro aqui é FATAL)
try {
  const bairros = await client.request(
    readItems("mp_bairros", {
      filter: {
        slug_bairro: { _eq: slug_bairro },
        ativo: { _eq: true },
      },
      limit: 1,
    })
  );

  bairro = bairros?.[0] ?? null;

  if (!bairro) {
    erroBairro = `Bairro não encontrado para slug_bairro = ${slug_bairro}`;
  }
} catch (e) {
  console.error("Erro ao carregar bairro:", e);
  erroBairro =
    "Erro ao carregar dados do bairro. Verifique o console do servidor.";
}

// 2) Buscar cards (erro aqui NÃO é fatal; só some os cards)
if (bairro) {
  try {
    cards = await client.request(
      readItems("mp_cards_anunciantes", {
        filter: {
          ativo: { _eq: true },
          // depois podemos filtrar por bairro_relacionado M2M
        },
        sort: ["ordem_exibicao"],
        limit: 10,
      })
    );
  } catch (e) {
    console.error("Erro ao carregar cards para o bairro:", e);
    avisoCards =
      "Os anunciantes deste bairro não puderam ser carregados no momento. Tente novamente mais tarde.";
    cards = [];
  }
}

// 3) Buscar categorias N1 (apenas para VISUALIZAR quais existem)
// (sem navegação, só rótulos na página do bairro)
try {
  categoriasN1 = await client.request(
    readItems("mp_categorias_locais", {
      filter: {
        ativo: { _eq: true },
        nivel_nicho: { _eq: 1 },
      },
      fields: ["id", "nome_nicho", "slug_nicho", "ordem_exibicao"],
      sort: ["ordem_exibicao", "nome_nicho"],
      limit: 50,
    })
  );
} catch (e) {
  console.error("Erro ao carregar categorias locais (N1):", e);
  categoriasN1 = [];
}

const card1 = cards?.[0];
const outrosCards = cards?.slice(1) ?? [];

const baseUrl = import.meta.env.DIRECTUS_URL || "";
const pageTitle = bairro
  ? `Negócios locais em ${bairro.nome_bairro} - São Paulo`
  : "Bairro - MaisPerto";
---

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>{pageTitle}</title>
  </head>
  <body
    style="
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
        sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f5f5f7;
    "
  >
    <main style="max-width: 960px; margin: 0 auto;">
      {erroBairro ? (
        <div
          style="
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
          "
        >
          <p style="margin: 0 0 0.25rem 0; font-weight: 600;">
            Ops, algo deu errado.
          </p>
          <p style="margin: 0; font-size: 0.9rem;">{erroBairro}</p>
        </div>
      ) : bairro ? (
        <header style="margin-bottom: 1.5rem;">
          {/* Breadcrumbs */}
          <nav style="margin-bottom: 0.25rem; font-size: 0.85rem; color: #666;">
            <a
              href="/"
              style="
                color: #2563eb;
                text-decoration: none;
              "
              onmouseover="this.style.textDecoration='underline'"
              onmouseout="this.style.textDecoration='none'"
            >
              São Paulo
            </a>
            <span style="margin: 0 0.25rem;">/</span>
            <span style="font-weight: 500;">{bairro.nome_bairro}</span>
          </nav>

          {/* Título */}
          <h1
            style="
              margin: 0 0 0.5rem 0;
              font-size: 2rem;
              color: #111827;
            "
          >
            Negócios locais em {bairro.nome_bairro}
          </h1>

          <p
            style="
              margin: 0;
              color: #374151;
              font-size: 0.98rem;
            "
          >
            Explore empresas, serviços e oportunidades neste bairro da cidade de
            São Paulo.
          </p>

          {/* Chips de categorias N1 (APENAS VISUAL, sem clique / sem navegar) */}
          {categoriasN1.length > 0 && (
            <div style="margin-top: 0.75rem;">
              <div
                style="
                  font-size: 0.8rem;
                  color: #6b7280;
                  margin-bottom: 0.25rem;
                "
              >
                Categorias disponíveis neste projeto (visualização geral – navegação por
                bairro e nicho será ligada em uma etapa futura):
              </div>
              {categoriasN1.map((cat) => (
                <span
                  style="
                    display: inline-block;
                    padding: 4px 10px;
                    margin: 0 6px 6px 0;
                    border-radius: 999px;
                    border: 1px solid #d1d5db;
                    background: #ffffff;
                    font-size: 0.8rem;
                    color: #111827;
                  "
                >
                  {cat.nome_nicho}
                </span>
              ))}
            </div>
          )}
        </header>
      ) : (
        <p style="color: #374151; font-size: 0.95rem;">
          Carregando informações do bairro…
        </p>
      )}

      {bairro && !erroBairro && (
        <>
          {/* Aviso de erro nos cards, se houver */}
          {avisoCards && (
            <div
              style="
                background: #fffbeb;
                border: 1px solid #fef3c7;
                color: #92400e;
                border-radius: 12px;
                padding: 0.75rem 1rem;
                margin-bottom: 1.25rem;
                font-size: 0.85rem;
              "
            >
              {avisoCards}
            </div>
          )}

          {/* CARD-1 */}
          {card1 && (
            <section style="margin-bottom: 1.5rem;">
              <CardLocalPrincipal
                titulo={
                  card1.titulo_card ?? "Anunciante em destaque neste bairro"
                }
                descricao={
                  card1.descricao_curta_card ??
                  "Divulgue a sua empresa com um card exclusivo neste bairro e alcance novos clientes."
                }
                imagem={
                  card1.imagem_principal
                    ? `${baseUrl}/assets/${card1.imagem_principal}`
                    : "/img/banner-300x600.webp.jpg"
                }
                url={`/ofertas/${card1.slug_card ?? "card-teste"}`}
              />
            </section>
          )}

          {/* CARD-2 – institucional */}
          <section style="margin-bottom: 1.5rem;">
            <CardPatrocinador
              contexto={`neste bairro (${bairro.nome_bairro})`}
              imagem="/img/banner-300x600.webp.jpg"
            />
          </section>

          {/* Outros cards */}
          {outrosCards.length > 0 && (
            <section style="margin-bottom: 1.5rem;">
              {outrosCards.map((card) => (
                <div style="margin-bottom: 1rem;">
                  <CardLocalPrincipal
                    titulo={card.titulo_card ?? "Negócio local"}
                    descricao={
                      card.descricao_curta_card ??
                      "Conheça este negócio local e os serviços que ele oferece."
                    }
                    imagem={
                      card.imagem_principal
                        ? `${baseUrl}/assets/${card.imagem_principal}`
                        : "/img/banner-300x600.webp.jpg"
                    }
                    url={`/ofertas/${card.slug_card ?? "card-teste"}`}
                  />
                </div>
              ))}
            </section>
          )}

          {/* Mensagem quando não há cards */}
          {cards.length === 0 && !avisoCards && (
            <section>
              <div
                style="
                  background: #ffffff;
                  border-radius: 12px;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
                  padding: 1.25rem 1.5rem;
                  font-size: 0.95rem;
                  color: #374151;
                "
              >
                Ainda não há anunciantes cadastrados para este bairro. Seja o
                primeiro a destacar sua empresa aqui.
              </div>
            </section>
          )}
        </>
      )}
    </main>
  </body>
</html>